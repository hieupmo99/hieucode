name: Sync to Dashboard

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'dags/**'
      - 'docker-compose.yml'
      - 'requirements.txt'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  sync-to-local:
    name: Create sync info (for dashboard)
    runs-on: ubuntu-latest  # Use ubuntu instead of macos (faster & free)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Get full history
    
    - name: Create sync information file
      run: |
        # Create sync info JSON
        cat > sync-info.json <<EOF
        {
          "last_sync": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "commit_sha": "${{ github.sha }}",
          "commit_message": $(echo '${{ github.event.head_commit.message }}' | jq -Rs .),
          "branch": "${{ github.ref_name }}",
          "author": "${{ github.event.head_commit.author.name }}",
          "files_changed": ${{ toJson(github.event.commits[0].modified) }}
        }
        EOF
        
        cat sync-info.json
    
    - name: Upload sync info as artifact
      uses: actions/upload-artifact@v4
      with:
        name: sync-info
        path: sync-info.json
        retention-days: 30
    
    - name: Create dashboard config
      run: |
        # Create config.py
        cat > config.py <<'EOF'
        """
        Dashboard Configuration
        Auto-generated by GitHub Actions
        """
        import os
        
        # Project paths
        HIEUCODE_DIR = os.path.expanduser('~/Documents/hieucode')
        DB_PATH = os.path.join(HIEUCODE_DIR, 'app', 'hieudb.db')
        
        # Kafka configuration
        KAFKA_BOOTSTRAP_SERVERS = [
            'localhost:19092',
            'localhost:29092', 
            'localhost:39092'
        ]
        KAFKA_TOPIC = 'vnexpress_topic'
        
        # Sync information
        LAST_COMMIT_SHA = '${{ github.sha }}'
        LAST_SYNC_TIME = '$(date -u +"%Y-%m-%dT%H:%M:%SZ")'
        BRANCH = '${{ github.ref_name }}'
        
        # Dashboard settings
        REFRESH_INTERVAL = 5  # seconds
        PORT = 5000
        DEBUG = True
        EOF
        
        echo "âœ… Configuration created!"
    
    - name: Upload config as artifact
      uses: actions/upload-artifact@v4
      with:
        name: dashboard-config
        path: config.py
        retention-days: 30
    
    - name: Summary
      run: |
        echo "âœ… Sync completed successfully!"
        echo ""
        echo "ðŸ“Š Sync Details:"
        echo "  Commit: ${{ github.sha }}"
        echo "  Author: ${{ github.event.head_commit.author.name }}"
        echo "  Branch: ${{ github.ref_name }}"
        echo "  Message: ${{ github.event.head_commit.message }}"
        echo ""
        echo "ðŸŒ Dashboard URL: http://localhost:5000"
        echo "ðŸ“ Dashboard Location: /Users/op-lt-0378/Documents/GitHub/action"
        echo ""
        echo "ðŸ’¡ Start dashboard with:"
        echo "   cd /Users/op-lt-0378/Documents/GitHub/action"
        echo "   python3 server.py"
