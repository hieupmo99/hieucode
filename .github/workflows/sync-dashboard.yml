name: Sync to Dashboard

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'dags/**'
      - 'docker-compose.yml'
      - 'requirements.txt'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  sync-to-local:
    name: Sync code to local dashboard folder
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Get full history
    
    - name: Create sync information file
      run: |
        # Create sync info JSON
        cat > sync-info.json <<EOF
        {
          "last_sync": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "commit_sha": "${{ github.sha }}",
          "commit_message": $(echo '${{ github.event.head_commit.message }}' | jq -Rs .),
          "branch": "${{ github.ref_name }}",
          "author": "${{ github.event.head_commit.author.name }}",
          "files_changed": ${{ toJson(github.event.commits[0].modified) }}
        }
        EOF
        
        cat sync-info.json
    
    - name: Copy sync info to dashboard
      run: |
        DASHBOARD_DIR="/Users/op-lt-0378/Documents/GitHub/action"
        
        echo "ğŸ“ Dashboard directory: $DASHBOARD_DIR"
        
        # Create dashboard directory if it doesn't exist
        mkdir -p "$DASHBOARD_DIR"
        
        # Copy sync info
        cp sync-info.json "$DASHBOARD_DIR/sync-info.json"
        
        echo "âœ… Sync info copied!"
    
    - name: Update dashboard configuration
      run: |
        DASHBOARD_DIR="/Users/op-lt-0378/Documents/GitHub/action"
        
        # Create/update config.py with paths
        cat > "$DASHBOARD_DIR/config.py" <<'EOF'
        """
        Dashboard Configuration
        Auto-generated by GitHub Actions
        """
        import os
        
        # Project paths
        HIEUCODE_DIR = os.path.expanduser('~/Documents/hieucode')
        DB_PATH = os.path.join(HIEUCODE_DIR, 'app', 'hieudb.db')
        
        # Kafka configuration
        KAFKA_BOOTSTRAP_SERVERS = [
            'localhost:19092',
            'localhost:29092', 
            'localhost:39092'
        ]
        KAFKA_TOPIC = 'vnexpress_topic'
        
        # Sync information
        LAST_COMMIT_SHA = '${{ github.sha }}'
        LAST_SYNC_TIME = '$(date -u +"%Y-%m-%dT%H:%M:%SZ")'
        BRANCH = '${{ github.ref_name }}'
        
        # Dashboard settings
        REFRESH_INTERVAL = 5  # seconds
        PORT = 5000
        DEBUG = True
        EOF
        
        echo "âœ… Configuration updated!"
        cat "$DASHBOARD_DIR/config.py"
    
    - name: Notify dashboard (if running)
      run: |
        # Try to send a notification to the dashboard if it's running
        curl -X POST http://localhost:5000/api/sync/notify \
          -H "Content-Type: application/json" \
          -d '{"message": "New sync from GitHub", "commit": "${{ github.sha }}"}' \
          2>/dev/null || echo "â„¹ï¸  Dashboard not running (this is okay)"
    
    - name: Summary
      run: |
        echo "âœ… Sync completed successfully!"
        echo ""
        echo "ğŸ“Š Sync Details:"
        echo "  Commit: ${{ github.sha }}"
        echo "  Author: ${{ github.event.head_commit.author.name }}"
        echo "  Branch: ${{ github.ref_name }}"
        echo "  Message: ${{ github.event.head_commit.message }}"
        echo ""
        echo "ğŸŒ Dashboard URL: http://localhost:5000"
        echo "ğŸ“ Dashboard Location: /Users/op-lt-0378/Documents/GitHub/action"
        echo ""
        echo "ğŸ’¡ Start dashboard with:"
        echo "   cd /Users/op-lt-0378/Documents/GitHub/action"
        echo "   python3 server.py"
