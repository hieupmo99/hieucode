# TikTok API Caller - Usage Guide

## Overview

The API Caller allows you to make TikTok Business API calls using the config file generated by the scraper. You just need to:
1. Load the config JSON
2. Provide access tokens
3. Provide parameter values
4. Run - it will call all APIs and save responses

## Files

- `tiktok_api_config.json` - Generated by scraper, contains all API call templates
- `api_caller.py` - Main API caller script
- `example_usage.py` - Example usage scripts

## Quick Start

### 1. Generate Config File

First, run the scraper to generate `tiktok_api_config.json`:

```bash
python api_crawl.py
```

This will create `tiktok_api_config.json` with all API configurations.

### 2. Use Command Line

```bash
# Single access token
python api_caller.py --tokens "your_access_token_here" --params '{"business_id":"123","video_id":"456"}'

# Multiple access tokens (comma-separated)
python api_caller.py --tokens "token1,token2,token3" --params '{"business_id":"123"}'

# Load tokens from file (one token per line)
python api_caller.py --tokens tokens.txt --params '{"business_id":"123"}'

# Custom output files
python api_caller.py --tokens "token" --output-json my_responses.json --output-excel my_responses.xlsx
```

### 3. Use Python Script

```python
from api_caller import TikTokAPICaller

# Initialize
caller = TikTokAPICaller(config_file='tiktok_api_config.json')

# Multiple access tokens (one per shop)
access_tokens = [
    'shop1_token',
    'shop2_token',
    'shop3_token'
]

# Parameter values
parameter_values = {
    'business_id': '1234567890',
    'video_id': '1234567890123456789',
    'text': 'Great video!'
}

# Make API calls
caller.call_all_apis(
    access_tokens=access_tokens,
    parameter_values=parameter_values,
    delay=1.0  # 1 second between calls
)

# Save results
caller.save_results_json('api_responses.json')
caller.save_results_excel('api_responses.xlsx')
```

## Config JSON Structure

Each API in `tiktok_api_config.json` looks like:

```json
{
  "api_name": "Create a new comment on an owned video",
  "method": "POST",
  "endpoint_url": "https://business-api.tiktok.com/open_api/v1.3/business/comment/create/",
  "headers": {
    "Access-Token": "{{Access-Token}}",
    "Content-Type": "application/json"
  },
  "parameters": {
    "business_id": "{{business_id}}",
    "video_id": "{{video_id}}",
    "text": "{{text}}"
  },
  "response_fields": ["code", "message", "data"],
  "example_code": [...]
}
```

## Placeholders

- `{{Access-Token}}` - Replaced with your access token
- `{{business_id}}` - Replaced with value from `parameter_values`
- `{{video_id}}` - Replaced with value from `parameter_values`
- etc.

## Output Files

### JSON (`api_responses.json`)
Contains full response data for each API call:
```json
[
  {
    "api_name": "Create a new comment",
    "endpoint_url": "...",
    "method": "POST",
    "token_id": "token_1",
    "status": "success",
    "status_code": 200,
    "response": {
      "code": 0,
      "message": "OK",
      "data": {...}
    },
    "timestamp": "2025-01-XX..."
  }
]
```

### Excel (`api_responses.xlsx`)
Contains 3 sheets:
1. **Summary** - All API calls with status
2. **Responses** - Successful responses (flattened)
3. **Errors** - Failed API calls with error details

## Integration with S3/Database

The response JSON can be easily loaded into your pipeline:

```python
import json

# Load responses
with open('api_responses.json', 'r') as f:
    responses = json.load(f)

# Process each response
for response in responses:
    if response['status'] == 'success':
        data = response['response']
        # Upload to S3 or insert to database
        # upload_to_s3(data)
        # insert_to_db(data)
```

## Parameters

- `--config` - Config JSON file (default: `tiktok_api_config.json`)
- `--tokens` - Access tokens (comma-separated or file path)
- `--params` - Parameter values as JSON string
- `--delay` - Delay between calls in seconds (default: 1.0)
- `--output-json` - Output JSON filename (default: `api_responses.json`)
- `--output-excel` - Output Excel filename (default: `api_responses.xlsx`)

## Example: Multiple Shops

```python
from api_caller import TikTokAPICaller

# Load config
caller = TikTokAPICaller('tiktok_api_config.json')

# Tokens for multiple shops
shop_tokens = {
    'shop1': 'token1',
    'shop2': 'token2',
    'shop3': 'token3'
}

# Call APIs for each shop
for shop_name, token in shop_tokens.items():
    print(f"Processing {shop_name}...")
    
    caller.results = []  # Reset results
    
    caller.call_all_apis(
        access_tokens=[token],
        parameter_values={'business_id': '123'},
        delay=1.0
    )
    
    # Save per shop
    caller.save_results_json(f'{shop_name}_responses.json')
    caller.save_results_excel(f'{shop_name}_responses.xlsx')
```

## Notes

- The script automatically handles GET, POST, PUT, DELETE methods
- Headers are automatically set (Access-Token, Content-Type, etc.)
- Parameters are sent as JSON body for POST/PUT, query params for GET
- Responses are automatically parsed to JSON
- Failed calls are tracked separately in the Errors sheet

